{% extends "base.html" %}

{% block title %}Caisse - StockMaster Pro{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ============================================
         EN-TÊTE DE PAGE
         ============================================ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 fw-bold text-dark">
                <i class="fas fa-cash-register text-success"></i>
                Caisse
            </h1>
            <p class="text-muted">Enregistrez une nouvelle vente</p>
        </div>
    </div>

    <!-- ============================================
         FORMULAIRE DE VENTE
         ============================================ -->
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="table-container">
                <h2 class="table-title">
                    <i class="fas fa-shopping-cart text-success"></i>
                    Nouvelle Vente
                </h2>

                {% if products %}
                <form method="POST" action="/sale/process" id="saleForm">
                    <div class="mb-4">
                        <label class="form-label">Sélectionner un produit</label>
                        <select class="form-select" name="product_id" id="productSelect" required>
                            <option value="" selected disabled>-- Choisir un produit --</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-stock="{{ product.stock_quantity }}"
                                data-price="{{ product.selling_price }}">
                                {{ product.name }} (Stock: {{ product.stock_quantity }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Quantité à vendre</label>
                        <input type="number" class="form-control" name="quantity_sold" id="quantityInput" min="1"
                            value="1" required>
                        <small class="text-muted" id="stockInfo"></small>
                    </div>

                    <div class="mb-4" id="pricePreview" style="display: none;">
                        <div class="alert alert-info alert-custom">
                            <strong>Prix total :</strong> <span id="totalPrice">0.00</span> FCFA
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success-custom btn-lg">
                            <i class="fas fa-check-circle"></i> Valider la vente
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-warning alert-custom">
                    <i class="fas fa-exclamation-triangle"></i>
                    Aucun produit disponible en stock. Veuillez ajouter des produits dans l'inventaire.
                </div>
                <a href="/inventory" class="btn btn-primary-custom">
                    <i class="fas fa-warehouse"></i> Aller à l'inventaire
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // JAVASCRIPT - CALCUL DYNAMIQUE DU PRIX TOTAL
    // ============================================
    const productSelect = document.getElementById('productSelect');
    const quantityInput = document.getElementById('quantityInput');
    const stockInfo = document.getElementById('stockInfo');
    const pricePreview = document.getElementById('pricePreview');
    const totalPrice = document.getElementById('totalPrice');

    function updatePricePreview() {
        const selectedOption = productSelect.options[productSelect.selectedIndex];

        if (selectedOption && selectedOption.value) {
            const stock = parseInt(selectedOption.dataset.stock);
            const price = parseFloat(selectedOption.dataset.price);
            const quantity = parseInt(quantityInput.value) || 0;

            // Afficher info stock
            stockInfo.textContent = `Stock disponible : ${stock} unités`;

            // Validation quantité
            if (quantity > stock) {
                quantityInput.setCustomValidity('Quantité supérieure au stock disponible');
                pricePreview.style.display = 'none';
            } else {
                quantityInput.setCustomValidity('');

                // Calcul et affichage du prix total
                const total = (price * quantity).toFixed(2);
                totalPrice.textContent = total;
                pricePreview.style.display = 'block';
            }
        } else {
            stockInfo.textContent = '';
            pricePreview.style.display = 'none';
        }
    }

    // Événements
    if (productSelect) {
        productSelect.addEventListener('change', updatePricePreview);
        quantityInput.addEventListener('input', updatePricePreview);
    }
</script>
{% endblock %}